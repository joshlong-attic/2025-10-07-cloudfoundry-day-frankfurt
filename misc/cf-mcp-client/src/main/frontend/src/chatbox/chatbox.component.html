<div class="chatbox" id="chatbox" role="log" aria-label="Chat conversation">
  <!-- Live region for screen reader announcements -->
  <div aria-live="polite" aria-atomic="false" class="sr-only" id="chat-status-live-region">
    <!-- Dynamic status messages will be announced here -->
  </div>

  <div #chatboxMessages class="chatbox-messages" role="log" aria-label="Chat messages">
    <!-- Chat messages will be dynamically inserted here -->
    @for (messageData of messagesWithReasoningFlags(); track messageData.index) {
      <div class="chat-message {{messageData.persona}}"
           role="article"
           [attr.aria-label]="messageData.persona === 'user' ? 'Your message' : 'Assistant response'">
        <mat-card appearance="outlined"
                  [attr.data-card-variant]="messageData.persona == 'user' ? 'user' : 'bot'"
                  class="md3-chat-card">
          <mat-card-content>
            @if (messageData.persona == 'user') {
              <div class="user-message-content" role="text">{{ messageData.text }}</div>
            } @else {
              <div class="bot-message-container">
                @if (messageData.typing) {
                  <div class="typing__dot" role="status" aria-label="Assistant is typing">
                    <div class="typing__dot"></div><div class="typing__dot"></div><div class="typing__dot"></div>
                    <span class="sr-only">Assistant is thinking...</span>
                  </div>
                } @else {
                  <div class="main-content" role="text">
                    <markdown [data]="messageData.text"></markdown>
                  </div>
                  @if (messageData.hasReasoning && messageData.reasoning) {
                    <mat-expansion-panel class="reasoning-expansion-panel"
                                       [expanded]="messageData.showReasoning"
                                       (expandedChange)="toggleReasoning(messageData.index)"
                                       aria-label="Reasoning details">
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <mat-icon class="reasoning-icon" aria-hidden="true">psychology</mat-icon>
                          <span class="reasoning-title">Reasoning</span>
                        </mat-panel-title>
                      </mat-expansion-panel-header>
                      <div class="reasoning-content" role="text">
                        <markdown [data]="messageData.reasoning"></markdown>
                      </div>
                    </mat-expansion-panel>
                  }
                  @if (messageData.hasError && messageData.error) {
                    <mat-expansion-panel class="error-expansion-panel"
                                       [expanded]="messageData.showError"
                                       (expandedChange)="toggleError(messageData.index)"
                                       aria-label="Error details">
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <mat-icon class="error-icon" aria-hidden="true">bug_report</mat-icon>
                          <span class="error-title">Error Details</span>
                        </mat-panel-title>
                      </mat-expansion-panel-header>
                      <div class="error-content" role="text">
                        <div class="error-field">
                          <strong>Type:</strong> {{ messageData.error.errorType }}
                        </div>
                        <div class="error-field">
                          <strong>Time:</strong> {{ messageData.error.timestamp }}
                        </div>
                        @if (messageData.error.stackTrace) {
                          <div class="error-field">
                            <strong>Stack Trace:</strong>
                            <pre class="error-stacktrace">{{ messageData.error.stackTrace }}</pre>
                          </div>
                        }
                      </div>
                    </mat-expansion-panel>
                  }
                }
              </div>
            }
          </mat-card-content>
        </mat-card>
      </div>
    }
  </div>
  <div class="chatbox-footer" role="form" aria-label="Send message">
    <ng-form class="chat-input-container">
      <button mat-icon-button type="button"
              class="prompt-button"
              (click)="openPromptSelection()"
              [disabled]="!hasAvailablePrompts() || isBusy()"
              [matTooltip]="hasAvailablePrompts() ? 'Select a prompt' : 'No prompts available'"
              [attr.aria-label]="hasAvailablePrompts() ? 'Select a prompt' : 'No prompts available'">
        <mat-icon [class.spinning]="isBusy()" aria-hidden="true">psychology</mat-icon>
      </button>

      <mat-form-field appearance="outline" class="chat-input-field">
        <mat-label>Type your message</mat-label>
        <textarea name="chatbox-input"
                  matInput
                  cdkTextareaAutosize
                  cdkAutosizeMinRows="1"
                  cdkAutosizeMaxRows="4"
                  [ngModel]="chatMessage()"
                  (ngModelChange)="updateChatMessage($event)"
                  [disabled]="isBusy()"
                  (keydown)="onEnterKeydown($event)"
                  aria-label="Type your message"
                  aria-describedby="chat-input-help"></textarea>
        <mat-hint id="chat-input-help" align="start">
          @if (isBusy()) {
            Please wait for the current message to complete
          } @else {
            Press Enter to send, Shift+Enter for new line
          }
        </mat-hint>
      </mat-form-field>

      <button mat-fab
              color="primary"
              type="button"
              class="send-fab"
              (click)="sendChatMessage()"
              [disabled]="!canSendMessage()"
              [matTooltip]="sendButtonTooltip()"
              [attr.aria-label]="sendButtonTooltip()">
        <mat-icon aria-hidden="true">send</mat-icon>
      </button>
    </ng-form>
  </div>
</div>
